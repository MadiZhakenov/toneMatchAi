# Финальный Протокол Тестирования (Testing Protocol)

## 1. AI Functionality Test

**Цель:** Проверить интеграцию Python-моста и корректность парсинга JSON результатов.

### Шаги:

1. Запустить DAW (Reaper/Cubase/Logic) и загрузить плагин ToneMatch AI
2. Нажать кнопку **"MATCH TONE!"** в Zone 1
3. Выбрать reference audio файл (.wav или .mp3)
4. Убедиться, что:
   - Плагин начинает захватывать DI-сигнал (индикатор активности)
   - Python-процесс запускается (проверить Task Manager / Activity Monitor)
   - Временный файл `tonematch_di.wav` создается в системной temp-папке
   - Python-скрипт `plugin/Scripts/run_match.py` выполняется
5. Дождаться завершения (3-5 минут)
6. Проверить результат:
   - JSON файл `tonematch_result.json` создан в temp-папке
   - Поля `FX_PATH`, `AMP_PATH`, `IR_PATH` в JSON содержат абсолютные пути к `.nam` и `.wav` файлам
   - Плагин автоматически загружает найденные модели (проверить в логах: `DBG("Loaded pedal model: ...")`)
   - Слоты FX/AMP/IR в UI обновляются с именами моделей
   - Label "LAST RIG FOUND" показывает найденный риг

### Ожидаемый результат:

- Все три модели (FX NAM, AMP NAM, IR) загружаются без ошибок
- Параметры Post-FX обновляются согласно JSON (`params` секция)
- Звук меняется после завершения матчинга

### Файлы для проверки:

- `plugin/Source/Bridge/PythonBridge.cpp` (строки 121-170) - парсинг JSON
- `plugin/Source/PluginProcessor.cpp` (строки 338-445) - применение рига
- `plugin/Scripts/run_match.py` - генерация JSON

---

## 2. DSP Processing Test (Real-time)

**Цель:** Убедиться, что реальное время обработки работает без артефактов.

### Шаги:

1. Загрузить плагин в DAW на аудио-трек
2. Воспроизвести гитарный DI-сигнал (моно или стерео)
3. Проверить:
   - **Латентность:** Нет заметной задержки при воспроизведении
   - **Артефакты:** Нет щелчков, клиппинга, искажений при старте/стопе
   - **Стабильность:** Плагин работает стабильно при длительном воспроизведении (5+ минут)
4. Загрузить разные NAM-модели вручную (через слоты FX/AMP):
   - Выбрать разные `.nam` файлы из `assets/nam_models/`
   - Убедиться, что звук **действительно меняется** при каждой загрузке
5. Загрузить разные IR:
   - Выбрать `.wav` файл из `assets/impulse_responses/`
   - Проверить, что кабинет меняет тембр

### Ожидаемый результат:

- Zero-latency processing (или минимальная задержка < 10ms)
- Нет артефактов при переключении моделей
- Каждая модель дает уникальный звук

### Критические файлы:

- `plugin/Source/DSP/DSPChain.cpp` - основная цепочка обработки
- `plugin/Source/DSP/NAMProcessor.cpp` (строки 36-83) - real-time обработка NAM
- `plugin/Source/PluginProcessor.cpp` (строки 142-222) - `processBlock`

---

## 3. UI/UX Test

**Цель:** Проверить связь UI-элементов с DSP-параметрами.

### Шаги:

1. **Post-FX Sliders (Zone 2):**
   - Двигать слайдер **Delay Time** → звук должен меняться (задержка становится длиннее/короче)
   - Двигать слайдер **Delay Mix** → wet/dry баланс меняется
   - Двигать слайдер **Reverb Wet** → реверб становится громче/тише
   - Двигать слайдер **Reverb Size** → размер комнаты меняется
   - Двигать слайдер **Final EQ Gain** (Zone 1) → общий гейн меняется

2. **Pre-EQ Knobs (Zone 2, если есть):**
   - Двигать **Pre-EQ Gain** → частотная характеристика меняется
   - Двигать **Pre-EQ Freq** → частота пика меняется

3. **Input Gain:**
   - Двигать **Input Gain** → входной уровень меняется

### Ожидаемый результат:

- Все слайдеры **мгновенно** влияют на звук (без задержки)
- Значения в текстовых полях обновляются в реальном времени
- Нет "залипания" слайдеров

### Файлы для проверки:

- `plugin/Source/PluginEditor.cpp` (строки 343-403) - настройка слайдеров
- `plugin/Source/UI/KnobStrip.cpp` (строки 34-35) - SliderAttachment
- `plugin/Source/DSP/DSPChain.cpp` (строки 84-160) - чтение параметров из APVTS

---

## 4. Preset Management Test

**Цель:** Проверить сохранение и загрузку пресетов.

### Шаги:

1. **Сохранение AI-найденного рига:**
   - Выполнить AI matching (шаг 1)
   - После завершения нажать **"SAVE AS PRESET"**
   - Выбрать место сохранения (например, `Documents/ToneMatchAI/Presets/`)
   - Указать имя пресета (например, `MyToneMatch.json`)
   - Проверить, что файл создан

2. **Проверка содержимого пресета:**
   - Открыть сохраненный `.json` файл
   - Убедиться, что присутствуют:
     - `rig.fx_nam_path` - абсолютный путь к FX NAM
     - `rig.amp_nam_path` - абсолютный путь к AMP NAM
     - `rig.ir_path` - абсолютный путь к IR
     - `params.*` - все параметры Post-FX

3. **Загрузка пресета:**
   - Загрузить другой пресет (или создать тестовый)
   - Убедиться, что:
     - Все три модели (FX/AMP/IR) загружаются автоматически
     - Все слайдеры Post-FX обновляются до сохраненных значений
     - Звук соответствует сохраненному состоянию

4. **Ручная правка и сохранение:**
   - Вручную изменить несколько параметров (Delay Time, Reverb Wet)
   - Сохранить как новый пресет
   - Загрузить другой пресет, затем вернуться к сохраненному
   - Убедиться, что ручные изменения восстановлены

### Ожидаемый результат:

- Пресеты сохраняют полное состояние плагина
- Загрузка пресета восстанавливает все параметры и модели
- Пути к моделям остаются валидными после перезапуска DAW

### Файлы для проверки:

- `plugin/Source/Preset/PresetManager.cpp` (строки 80-123) - сериализация/десериализация
- `plugin/Source/PluginProcessor.cpp` (строки 440-443) - загрузка пресета
- `plugin/Resources/default_preset.json` - пример формата

---

## 5. Чеклист Перед Релизом

- [ ] Все тесты из разделов 1-4 пройдены успешно
- [ ] Плагин компилируется без warnings в Release режиме
- [ ] Python-скрипт `run_match.py` доступен рядом с бинарником
- [ ] Пути к моделям (`assets/nam_models/`, `assets/impulse_responses/`) корректны
- [ ] Пресеты сохраняют и загружают полное состояние
- [ ] Нет memory leaks (проверено через Valgrind / Visual Studio Diagnostic Tools)
- [ ] Латентность < 10ms при стандартных настройках буфера
- [ ] Плагин работает стабильно в течение 30+ минут непрерывной работы
- [ ] UI элементы корректно отображаются на разных разрешениях
- [ ] Документация обновлена (README.md, если требуется)

---

## 6. Troubleshooting

**Проблема:** Python-процесс не запускается
- **Решение:** Проверить, что Python установлен и доступен в PATH. Проверить путь к `run_match.py` в `PythonBridge.cpp`.

**Проблема:** Модели не загружаются
- **Решение:** Проверить абсолютные пути в JSON. Убедиться, что файлы `.nam` и `.wav` существуют по указанным путям.

**Проблема:** Артефакты при переключении моделей
- **Решение:** Проверить thread-safety в `NAMProcessor::loadModel()` (используется `std::mutex`).

**Проблема:** Пресеты не загружаются после перезапуска
- **Решение:** Проверить, что пути в пресетах абсолютные или относительные к фиксированной базе.

**Проблема:** Слайдеры не влияют на звук
- **Решение:** Проверить, что `SliderAttachment` правильно создан и привязан к APVTS параметру. Проверить, что DSP-цепочка читает параметры из APVTS.

**Проблема:** DI capture не работает
- **Решение:** Убедиться, что `startCapturingDI()` вызывается при нажатии кнопки. Проверить размер буфера захвата.

